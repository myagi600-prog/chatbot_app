# AIチャットボット 引継ぎ資料 (最終版)

## 1. 基本的な使用サービス情報

*   **AIモデル**: Google Gemini (使用モデル: `models/gemini-pro-latest`)
*   **Webフレームワーク**: Streamlit
*   **デプロイ環境**: Streamlit Community Cloud
*   **RAG関連ライブラリ**:
    *   LangChain (RAGフレームワーク)
    *   HuggingFaceEmbeddings (Embeddingモデル: `paraphrase-multilingual-MiniLM-L12-v2` を利用)
    *   DocArrayInMemorySearch (インメモリベクトルストア)
*   **ファイル処理ライブラリ**:
    *   PyPDFLoader (PDFファイル読み込み)
    *   Docx2txtLoader (Wordファイル読み込み)
    *   TextLoader (テキストファイル読み込み)
    *   UnstructuredExcelLoader (Excelファイル読み込み、`unstructured[xlsx]`パッケージを使用)

## 2. 開発内容

本プロジェクトでは、独自のファイル（PDF, Word, Excel, TXT）を知識ベースとして利用できるAIチャットボットの開発を行いました。主な開発内容は以下の通りです。

*   **AIチャットボットの基本機能実装**: Google Gemini APIと連携したチャット機能およびRAG（Retrieval-Augmented Generation）機能を実装しました。
*   **Excelファイル処理の安定化**: 従来の`openpyxl`による手動読み込み処理で発生していたフロントエンドのクラッシュ問題に対し、より堅牢な`unstructured`ライブラリ（`UnstructuredExcelLoader`）を導入することで解決しました。
*   **Geminiモデル名のデプロイ環境への適合**: デプロイ環境で`gemini-1.5-flash`モデルが利用できない問題が発生したため、利用可能なモデルを特定し、`gemini-pro`を経て最終的に`models/gemini-pro-latest`モデルを使用するように修正しました。
*   **知識ベースの追加機能**: 既存の知識ベースに新しいファイルの内容を追加（マージ）できる機能を実装しました。
*   **知識ベースのクリア機能**: 知識ベースの内容をリセットするための「知識ベースをクリア」ボタンをサイドバーに追加しました。
*   **ファイルアップローダーの表示テキストと対応ファイルタイプの調整**: ユーザーの要望に基づき、ファイルアップローダーの表示テキストを「知識ファイル（メモ帳/Word/Excelなど）をアップロード」に変更し、対応ファイルタイプを`.txt`, `.xlsx`, `.xls`, `.docx`に絞り込みました。
*   **チャットタイトルの変更**: アプリケーションのタイトルを「SmartAssistant」に変更しました。
*   **AIプロンプトの調整**: AIの応答スタイルを「あらゆる分野のエキスパートで、初心者にも分かりやすく説明し、簡潔かつ関連性のあるアドバイスも含む」ように調整しました。
*   **RAGロジックの変更**: 質問が知識ベースと関連するかどうかにかかわらず、知識ベースが構築されていれば常にその情報をAIに提供し、AIがそれを一般的な知識と合わせて回答に活用するように変更しました。
*   **画像ファイルのRAG対応**: 一時的に画像処理ロジックの追加を試みましたが、実用性の観点から見送られました。

## 3. 現在の状況

*   WebアプリはStreamlit Community Cloudにデプロイ済みです。
*   Gemini APIを利用したチャット機能は正常に動作しています。
*   テキストファイル、Wordファイル、Excelファイルを知識ベースとしてアップロードし、その内容に基づいてAIが回答するRAG機能は正常に動作しています。
*   複数のファイルをアップロードして既存の知識ベースに追加する機能も正常に動作します。
*   知識ベースをクリアする機能も正常に動作します。
*   チャットタイトルは「SmartAssistant」です。
*   ファイルアップローダーは、メモ帳（.txt）、Word（.docx）、Excel（.xlsx, .xls）ファイルに対応しています。
*   知識ベースクリア後に会話を開始しようとするとエラーが発生する問題は、`vector_store`が`None`の場合に適切な警告を表示するように修正され、解消済みです。
*   AIのプロンプトは、ユーザーの指示に基づき「あらゆる分野のエキスパートで、初心者にも分かりやすく説明し、簡潔かつ関連性のあるアドバイスも含む」ように調整済みです。
*   RAGのロジックは、一般的な知識を大前提とし、知識ベースの情報をプラスして回答するよう変更されています。

### バックアップ情報

*   **現在のGitコミットハッシュ**: `7cdcc08`
*   **コミットメッセージ**: `Feat: Always use RAG context if available, blending with general knowledge`
*   **備考**: このコミットは、RAGのロジックを「一般的な知識に知識ベースの情報をプラスする」形に変更した時点のものです。Gitの履歴を辿ることで、いつでもこの状態に戻すことが可能です。

### 次のステップ（今後の改善点）

*   **知識データの取り扱い**: 
    *   知識ベースからの特定のファイルの削除機能。
    *   知識ベースの永続化（アプリ再起動後も知識ベースが保持されるようにする）。
    *   より高度な知識の追加・更新・削除インターフェースの検討。
*   **AIの挙動のさらなる調整**: 
    *   プロンプトの微調整による回答品質の向上。
    *   RAGの検索結果の表示（AIがどの情報に基づいて回答したかを示す）。
*   **エラーハンドリングの強化**: ファイルアップロード時やAPI呼び出し時のエラーメッセージの改善。
